WITH FilteredLatest AS (
    SELECT t.*
    FROM YourTable t
    CROSS APPLY (
        SELECT MAX(DateColumn) AS MaxDate
        FROM YourTable
        WHERE YEAR(DateColumn) = YEAR(t.DateColumn)
          AND MONTH(DateColumn) = MONTH(t.DateColumn)
          AND YEAR(DateColumn) = 2017  -- Filter year 2017 here to speed up
    ) m
    WHERE t.DateColumn = m.MaxDate
      AND YEAR(t.DateColumn) = 2017  -- Filter year 2017 here as well
),

QuarterlySums AS (
    SELECT 
        YEAR(DateColumn) AS Yr,
        DATEPART(QUARTER, DateColumn) AS Quarter,
        LOB,
        Type,
        SUM(Quantity) AS QtySum
    FROM FilteredLatest
    GROUP BY YEAR(DateColumn), DATEPART(QUARTER, DateColumn), LOB, Type
),

SharedServerSum AS (
    SELECT
        Yr,
        Quarter,
        -- Total shared servers physical sum (all LOB = 'shared server' physical servers)
        SUM(CASE WHEN Type = 'physical server' AND LOB = 'shared server' THEN QtySum ELSE 0 END) AS SharedServerSum,
        
        SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS TotalVirtualSum,

        -- EET Sum: physical servers in 'apphost hvd' or 'apphost ws' (assumed LOB)
        SUM(CASE 
                WHEN Type = 'physical server' 
                     AND LOB IN ('apphost hvd', 'apphost ws') 
                THEN QtySum ELSE 0 
            END) AS EET_Sum,

        -- CTI Sum: physical servers that are shared servers but NOT EET
        SUM(CASE 
                WHEN Type = 'physical server' 
                     AND LOB = 'shared server'
                     AND LOB NOT IN ('apphost hvd', 'apphost ws') -- or just else condition if needed
                THEN QtySum ELSE 0 
            END) AS CTI_Sum
    FROM QuarterlySums
    GROUP BY Yr, Quarter
)

SELECT 
    q.Yr,
    q.Quarter,
    q.LOB,
    
    -- Physical quantity plus EET shared servers
    SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) + s.EET_Sum AS PhysicalQty,
    
    SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) AS VirtualQty,
    
    -- Average shared server count for the quarter (total shared server physical / 3 months)
    s.SharedServerSum / 3.0 AS SharedServerAvg,
    
    -- VirtualAdd proportional to CTI shared server average for the quarter
    CASE 
        WHEN s.TotalVirtualSum > 0 THEN
            (SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / CAST(s.TotalVirtualSum AS FLOAT)) * (s.CTI_Sum / 3.0)
        ELSE 0
    END AS VirtualAdd,
    
    -- Total quantity = Physical + VirtualAdd
    (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) + s.EET_Sum) +
    CASE 
        WHEN s.TotalVirtualSum > 0 THEN
            (SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / CAST(s.TotalVirtualSum AS FLOAT)) * (s.CTI_Sum / 3.0)
        ELSE 0
    END AS TotalQty
FROM QuarterlySums q
JOIN SharedServerSum s ON q.Yr = s.Yr AND q.Quarter = s.Quarter
WHERE q.LOB <> 'shared server'  -- Exclude full shared server row to avoid double counting
GROUP BY q.Yr, q.Quarter, q.LOB, s.SharedServerSum, s.TotalVirtualSum, s.EET_Sum, s.CTI_Sum
ORDER BY q.Yr, q.Quarter, q.LOB;
