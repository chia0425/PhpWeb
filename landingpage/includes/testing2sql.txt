WITH FilteredLatest AS (
    SELECT t.*
    FROM YourTable t
    CROSS APPLY (
        SELECT MAX(DateColumn) AS MaxDate
        FROM YourTable
        WHERE YEAR(DateColumn) = YEAR(t.DateColumn)
          AND MONTH(DateColumn) = MONTH(t.DateColumn)
          AND YEAR(DateColumn) = 2017
    ) m
    WHERE t.DateColumn = m.MaxDate
      AND YEAR(t.DateColumn) = 2017
),

-- Attach HostingType info via LEFT JOIN
WithHostingType AS (
    SELECT 
        f.*, 
        t2.HostingType,
        CASE 
            WHEN f.Type = 'physical server' AND f.LOB = 'shared server' AND t2.HostingType IN ('apphost hvd', 'apphost ws') THEN 'EET'
            WHEN f.Type = 'physical server' AND f.LOB = 'shared server' THEN 'CTI'
            ELSE NULL
        END AS SharedServerCategory
    FROM FilteredLatest f
    LEFT JOIN Table2 t2 ON f.SerialNumber = t2.SerialNumber
),

QuarterlySums AS (
    SELECT 
        YEAR(DateColumn) AS Yr,
        DATEPART(QUARTER, DateColumn) AS Quarter,
        LOB,
        Type,
        SharedServerCategory,
        SUM(Quantity) AS QtySum
    FROM WithHostingType
    GROUP BY YEAR(DateColumn), DATEPART(QUARTER, DateColumn), LOB, Type, SharedServerCategory
),

SharedServerSum AS (
    SELECT
        Yr,
        Quarter,
        SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS TotalVirtualSum,
        SUM(CASE WHEN SharedServerCategory = 'EET' THEN QtySum ELSE 0 END) AS EET_Sum,
        SUM(CASE WHEN SharedServerCategory = 'CTI' THEN QtySum ELSE 0 END) AS CTI_Sum,
        SUM(CASE WHEN Type = 'virtual' AND SharedServerCategory = 'EET' THEN QtySum ELSE 0 END) AS EETVirtualSum
    FROM QuarterlySums
    GROUP BY Yr, Quarter
)

SELECT 
    q.Yr,
    q.Quarter,
    q.LOB,

    CASE 
        WHEN q.LOB = 'EET' THEN
            -- EET physical + EET shared server + EET virtual portion (corrected)
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) +  -- EET Physical avg
            (s.EET_Sum / 3.0) +  -- EET Shared Server avg
            CASE
                WHEN s.TotalVirtualSum > 0 THEN
                    (s.EETVirtualSum / s.TotalVirtualSum) * (s.CTI_Sum / 3.0)
                ELSE 0
            END
        ELSE
            -- For others, just physical avg without EET addition
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0)
    END AS PhysicalQty,

    -- Virtual Quantity (quarterly average)
    SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / 3.0 AS VirtualQty,

    -- Shared Server CTI avg (used to compute virtual add)
    s.CTI_Sum / 3.0 AS SharedServerAvg,

    -- Virtual Add based on proportion of virtual qty (non-EET LOBs)
    CASE 
        WHEN s.TotalVirtualSum > 0 AND q.LOB <> 'EET' THEN
            ((SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / CAST(s.TotalVirtualSum AS FLOAT)) * (s.CTI_Sum / 3.0))
        ELSE 0
    END AS VirtualAdd,

    -- Final Total = PhysicalQty + VirtualAdd (correctly handles EET case inside PhysicalQty already)
    CASE 
        WHEN q.LOB = 'EET' THEN
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) +
            (s.EET_Sum / 3.0) +
            CASE
                WHEN s.TotalVirtualSum > 0 THEN
                    (s.EETVirtualSum / s.TotalVirtualSum) * (s.CTI_Sum / 3.0)
                ELSE 0
            END
        ELSE
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) +
            CASE 
                WHEN s.TotalVirtualSum > 0 THEN
                    ((SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / CAST(s.TotalVirtualSum AS FLOAT)) * (s.CTI_Sum / 3.0))
                ELSE 0
            END
    END AS TotalQty

FROM QuarterlySums q
JOIN SharedServerSum s ON q.Yr = s.Yr AND q.Quarter = s.Quarter
WHERE q.LOB <> 'shared server'  -- exclude base shared server row
GROUP BY q.Yr, q.Quarter, q.LOB, s.EET_Sum, s.CTI_Sum, s.TotalVirtualSum, s.EETVirtualSum
ORDER BY q.Yr, q.Quarter, q.LOB;
