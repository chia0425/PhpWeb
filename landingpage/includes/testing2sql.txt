SELECT 
    q.Yr,
    q.Quarter,
    q.LOB,

    -- PhysicalQty: add EET shared servers only if LOB = EET
    CASE 
        WHEN LOWER(q.LOB) = 'eet' THEN
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) + (s.EET_Sum / 3.0)
        ELSE
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0)
    END AS PhysicalQty,

    -- VirtualQty: quarterly average virtual qty for this LOB
    (SUM(CASE WHEN q.Type = 'virtual' THEN q.QtySum ELSE 0 END) / 3.0) AS VirtualQty,

    -- Shared server CTI average
    (s.CTI_Sum / 3.0) AS SharedServerAvg,

    -- VirtualAdd proportional for all LOBs
    CASE 
        WHEN s.TotalVirtualSum > 0 THEN
            (v.VirtualSum / s.TotalVirtualSum) * (s.CTI_Sum / 3.0)
        ELSE 0
    END AS VirtualAdd,

    -- TotalQty = PhysicalQty + VirtualAdd
    CASE 
        WHEN LOWER(q.LOB) = 'eet' THEN
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) + 
            (s.EET_Sum / 3.0) +
            CASE 
                WHEN s.TotalVirtualSum > 0 THEN
                    (v.VirtualSum / s.TotalVirtualSum) * (s.CTI_Sum / 3.0)
                ELSE 0
            END
        ELSE
            (SUM(CASE WHEN q.Type = 'physical server' THEN q.QtySum ELSE 0 END) / 3.0) +
            CASE 
                WHEN s.TotalVirtualSum > 0 THEN
                    (v.VirtualSum / s.TotalVirtualSum) * (s.CTI_Sum / 3.0)
                ELSE 0
            END
    END AS TotalQty

FROM QuarterlySums q
JOIN SharedServerSum s ON q.Yr = s.Yr AND q.Quarter = s.Quarter
LEFT JOIN (
    SELECT Yr, Quarter, LOB, SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS VirtualSum
    FROM QuarterlySums
    GROUP BY Yr, Quarter, LOB
) v ON q.Yr = v.Yr AND q.Quarter = v.Quarter AND q.LOB = v.LOB
WHERE q.LOB <> 'shared server'  -- exclude base shared server row
GROUP BY q.Yr, q.Quarter, q.LOB, q.SharedServerCategory, s.EET_Sum, s.CTI_Sum, s.TotalVirtualSum, v.VirtualSum
ORDER BY q.Yr, q.Quarter, q.LOB;
