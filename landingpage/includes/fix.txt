WITH FilteredLatest AS (
    SELECT t.*
    FROM YourTable t
    CROSS APPLY (
        SELECT MAX(DateColumn) AS MaxDate
        FROM YourTable
        WHERE YEAR(DateColumn) = YEAR(t.DateColumn)
          AND MONTH(DateColumn) = MONTH(t.DateColumn)
          AND YEAR(DateColumn) = 2017
    ) m
    WHERE t.DateColumn = m.MaxDate
      AND YEAR(t.DateColumn) = 2017
),

WithHostingType AS (
    SELECT 
        f.*, 
        t2.HostingType,
        CASE 
            WHEN f.Type = 'physical server' AND f.LOB = 'shared server' AND t2.HostingType IN ('apphost hvd', 'apphost ws') THEN 'EET'
            WHEN f.Type = 'physical server' AND f.LOB = 'shared server' THEN 'CTI'
            ELSE NULL
        END AS SharedServerCategory
    FROM FilteredLatest f
    LEFT JOIN Table2 t2 ON f.SerialNumber = t2.SerialNumber
),

QuarterlySums AS (
    SELECT 
        YEAR(DateColumn) AS Yr,
        DATEPART(QUARTER, DateColumn) AS Quarter,
        LOB,
        Type,
        SharedServerCategory,
        SUM(Quantity) AS QtySum
    FROM WithHostingType
    GROUP BY YEAR(DateColumn), DATEPART(QUARTER, DateColumn), LOB, Type, SharedServerCategory
),

-- Generate all combinations of Yr, Quarter, LOB to fill missing quarters with zero
AllCombinations AS (
    SELECT DISTINCT Yr, LOB, Quarter
    FROM (
        SELECT DISTINCT Yr FROM QuarterlySums
    ) AS Years
    CROSS JOIN (
        SELECT DISTINCT LOB FROM QuarterlySums
    ) AS Lobs
    CROSS JOIN (VALUES (1),(2),(3),(4)) AS Quarters(Quarter)
),

QuarterlySumsFilled AS (
    SELECT 
        ac.Yr, 
        ac.Quarter, 
        ac.LOB,
        ISNULL(qs.Type, '') AS Type,
        ISNULL(qs.SharedServerCategory, '') AS SharedServerCategory,
        ISNULL(qs.QtySum, 0) AS QtySum
    FROM AllCombinations ac
    LEFT JOIN QuarterlySums qs 
        ON ac.Yr = qs.Yr AND ac.Quarter = qs.Quarter AND ac.LOB = qs.LOB
),

SharedServerSum AS (
    SELECT
        Yr,
        Quarter,
        SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS TotalVirtualSum,
        SUM(CASE WHEN SharedServerCategory = 'EET' THEN QtySum ELSE 0 END) AS EET_Sum,
        SUM(CASE WHEN SharedServerCategory = 'CTI' THEN QtySum ELSE 0 END) AS CTI_Sum
    FROM QuarterlySumsFilled
    GROUP BY Yr, Quarter
),

VirtualSumsPerLOB AS (
    SELECT Yr, Quarter, LOB, SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS VirtualSum
    FROM QuarterlySumsFilled
    GROUP BY Yr, Quarter, LOB
),

-- Now aggregate yearly by summing all 4 quarters, then divide by 4 to get yearly average
YearlySums AS (
    SELECT 
        Yr,
        LOB,
        SUM(CASE WHEN Type = 'physical server' THEN QtySum ELSE 0 END) AS PhysicalSum,
        SUM(CASE WHEN Type = 'virtual' THEN QtySum ELSE 0 END) AS VirtualSum
    FROM QuarterlySumsFilled
    GROUP BY Yr, LOB
),

-- Sum shared server sums by year (sum quarterly and divide by 4 later)
SharedServerSumYearly AS (
    SELECT
        Yr,
        SUM(EET_Sum) AS EET_Sum_Yearly,
        SUM(CTI_Sum) AS CTI_Sum_Yearly,
        SUM(TotalVirtualSum) AS TotalVirtualSum_Yearly
    FROM SharedServerSum
    GROUP BY Yr
),

VirtualSumsPerLOBYearly AS (
    SELECT
        Yr,
        LOB,
        SUM(VirtualSum) AS VirtualSum_Yearly
    FROM VirtualSumsPerLOB
    GROUP BY Yr, LOB
)

SELECT
    y.Yr,
    y.LOB,

    -- PhysicalQty yearly average = sum physical over year / 4
    CASE
        WHEN LOWER(y.LOB) = 'eet' THEN
            (y.PhysicalSum / 4.0) + (ss.EET_Sum_Yearly / 4.0)
        ELSE
            (y.PhysicalSum / 4.0)
    END AS PhysicalQty,

    -- VirtualQty yearly average = sum virtual over year / 4
    (y.VirtualSum / 4.0) AS VirtualQty,

    -- SharedServer CTI yearly average = CTI sum yearly / 4
    (ss.CTI_Sum_Yearly / 4.0) AS SharedServerAvg,

    -- Virtual Add proportional to virtual qty per LOB (yearly)
    CASE
        WHEN ss.TotalVirtualSum_Yearly > 0 THEN
            (v.VirtualSum_Yearly / ss.TotalVirtualSum_Yearly) * (ss.CTI_Sum_Yearly / 4.0)
        ELSE 0
    END AS VirtualAdd,

    -- TotalQty yearly average (physical + virtual add + EET if applicable)
    CASE
        WHEN LOWER(y.LOB) = 'eet' THEN
            (y.PhysicalSum / 4.0) +
            (ss.EET_Sum_Yearly / 4.0) +
            CASE
                WHEN ss.TotalVirtualSum_Yearly > 0 THEN
                    (v.VirtualSum_Yearly / ss.TotalVirtualSum_Yearly) * (ss.CTI_Sum_Yearly / 4.0)
                ELSE 0
            END
        ELSE
            (y.PhysicalSum / 4.0) +
            CASE
                WHEN ss.TotalVirtualSum_Yearly > 0 THEN
                    (v.VirtualSum_Yearly / ss.TotalVirtualSum_Yearly) * (ss.CTI_Sum_Yearly / 4.0)
                ELSE 0
            END
    END AS TotalQty

FROM YearlySums y
JOIN SharedServerSumYearly ss ON y.Yr = ss.Yr
LEFT JOIN VirtualSumsPerLOBYearly v ON y.Yr = v.Yr AND y.LOB = v.LOB

WHERE y.LOB <> 'shared server'

ORDER BY y.Yr, y.LOB;
